# 后端培训

标签： 培训资料 数据访问组件 配置管理组件 日志组件 项目实战和部署

---

[TOC]

一、数据访问组件
============================================
1、组件说明
------------------------------
- framework-persistence-1.0.0.jar;

- 基于**Spring Boot**

- 采用**MyBatis**持久层框架,支持定制化SQL、存储过程以及高级映射;

- 使用基于Mybatis分页插件**PageHelper**，支持Oracle、Mysql、Informix等13种数据库

- 提供数据访问各层通用**基类**

2、使用说明
----------------------------
### 2.1、使用规则
#### 2.1.1、 pom.xml添加添加依赖：
```
		<dependency>
			<groupId>com.boco.rnop.framework</groupId>
			<artifactId>framework-persistence</artifactId>
			<version>${boco.framework.version}</version>
		</dependency>
```
`注意：该组件pom.xml会读取系统环境变量JAVA_HOME，需配置环境变量.`
```
        <dependency>
			<groupId>jdk.tools</groupId>
			<artifactId>jdk.tools</artifactId>
			<version>1.6</version>
			<scope>system</scope>
			<systemPath>${JAVA_HOME}/lib/tools.jar</systemPath>
		</dependency>
```
#### 2.1.2、 启动类添加注解定义自动加载扫描范围及PageHelper分页插件配置
```
@EnableAutoConfiguration(exclude = { PageHelperAutoConfiguration.class })
@ComponentScan(basePackages = { "com.boco.rnop" })
```
#### 2.1.3、 application.yml配置数据库参数
```
# 数据库配置
spring:
  datasource:
    oracle:
      driver-class-name: oracle.jdbc.driver.OracleDriver
      url: jdbc:oracle:thin:@101.221.177.4:1521:niosserver
      username: niosdb
      password: niosdb
    informix:
      driver-class-name: com.informix.jdbc.IfxDriver
      url: jdbc:informix-sqli://10.10.1.91:8001/niosdbhlj:informixserver=niosserver201;Database=sysmaster
      username: informix
      password: informix 
    impala: 
      driver-class-name: com.informix.jdbc.IfxDriver
      url: jdbc:informix-sqli://10.10.1.91:8001/niosdbhlj:informixserver=niosserver201;Database=niosdbhlj;newcodeset=gbk,8859-1,819;Database locale=en_US.819;ClientLocale=en_us.8859-1;
      username: informix
      password: informix
    default1:
      db-type: informix
      driver-class-name: com.informix.jdbc.IfxDriver
      url: jdbc:informix-sqli://10.10.1.91:8001/niosdbhlj:informixserver=niosserver201;Database=niosdbhlj;newcodeset=gbk,8859-1,819;Database locale=en_US.819;ClientLocale=en_us.8859-1;
      username: informix
      password: informix 
    default: 
      db-type: oracle #网优数据库类型 oracle/informix
      driver-class-name: oracle.jdbc.driver.OracleDriver
      url: jdbc:oracle:thin:@10.10.2.31:1521:test
      username: niosdb_ah
      password: niosdb_ah
   
  data:
    solr: 
      host: http://10.10.2.191:8983/solr
    hbase: 
      quorum: 10.60.0.7:2181
      rootDir: E:\\Hadoop"
      nodeParent: 

hbase:
  zookeeper:
    quorum: 10.60.0.7:2181
```
#### 2.1.4、 MyBatis mapper.xml文件放置位置
![image.png-9.9kB][1]
```
存放目录规则：mybatis/mapper/数据库类型(oracle、informix、impala、default等)/*.xml
default特殊放置位置：
mybatis/mapper/default/common/*.xml
mybatis/mapper/default/（${spring.datasource.default.db-type}）/*.xml"
```
#### 2.1.5、 Mapper.java文件放置位置
![image.png-10.3kB][2]
```
包名命名规则：
com.boco.rnop.framework.persistence.数据库类型(oracle、informix、impala、default等).mapper
或com.boco.rnop.*.*.persistence.数据库类型(oracle、informix、impala、default等).mapper
```
### 2.2、数据访问基类使用
`部分用于代码生成器模板，个人开发不建议使用`
#### 2.2.1、com.boco.rnop.framework.persistence.BaseController（Controller基类）
```
	/**
	 * 设置PageHelper分页插件参数 （可从request获取参数pageNum，pageSize，orderBy）
	 * 
	 * @throws Exception
	 */
	protected void setPageHelperParam() throws Exception;
```
#### 2.2.2、com.boco.rnop.framework.persistence.BaseMapper(Mapper基类)
```
提供基本的增、删、改、查接口


	/**
	 * 新增一条记录
	 * 
	 * @param t
	 * @return
	 * @throws DataAccessException
	 */
	public int insert(PO po) throws DataAccessException;

	/**
	 * 根据主键删除一条记录
	 * 
	 * @param pk
	 * @return
	 * @throws DataAccessException
	 */
	public int deleteByPK(PK pk) throws DataAccessException;

	/**
	 * 根据主键删除多条记录
	 * 
	 * @param pks
	 * @return
	 * @throws DataAccessException
	 */
	public int deleteByPKs(List<PK> pks) throws DataAccessException;

	/**
	 * 根据自定义whereStr条件语句删除记录，如"id='1' and name='a'"
	 * 
	 * @param whereStr
	 * @return
	 * @throws DataAccessException
	 */
	public int deleteByWhere(@Param(value = "whereStr") String whereStr) throws DataAccessException;

	/**
	 * 根据主键修改一条记录
	 * 
	 * @param t
	 * @return
	 * @throws DataAccessException
	 */
	public int updateByPK(PO po) throws DataAccessException;

	/**
	 * TODO 批量修改,参数map:列名=列值，keyList={1,2,3...}.
	 *
	 * @param map
	 * @return
	 * @throws DataAccessException
	 */
	public int update(Map<String, Object> map) throws DataAccessException;

	/**
	 * 根据自定义whereStr条件语句修改记录
	 * 
	 * @param map
	 *            参数map:列名=列值
	 * @param whereStr
	 *            "id='1' and name='a'"
	 * @return
	 * @throws DataAccessException
	 */
	public int updateByWhere(PO po, @Param(value = "whereStr") String whereStr) throws DataAccessException;

	/**
	 * 根据主键查询一条记录
	 * 
	 * @param pk
	 * @return
	 * @throws DataAccessException
	 */
	public PO selectByPK(PK pk) throws DataAccessException;

	/**
	 * 根据条件查询记录
	 * 
	 * @param t
	 * @return
	 * @throws DataAccessException
	 */
	public List<PO> selectByAttr(QO qo) throws DataAccessException;

	/**
	 * 根据自定义whereStr条件语句查询记录
	 * 
	 * @param whereStr
	 * @return
	 * @throws DataAccessException
	 */
	public List<PO> selectByWhere(@Param(value = "whereStr") String whereStr) throws DataAccessException;

	/**
	 * 根据条件查询记录数
	 * 
	 * @param t
	 * @return
	 * @throws DataAccessException
	 */
	public int countByAttr(QO qo) throws DataAccessException;

	/**
	 * 根据自定义whereStr条件语句查询记录数
	 * 
	 * @param whereStr
	 * @return
	 * @throws DataAccessException
	 */
	public int countByWhere(@Param(value = "whereStr") String whereStr) throws DataAccessException;
```
#### 2.2.3、com.boco.rnop.framework.persistence.IBaseDaoService(IService基类)
```
	/**
	 * 新增一条记录
	 * 
	 * @param t
	 * @return
	 * @throws DataAccessException
	 */
	public int insert(PO t) throws DataAccessException;

	/**
	 * 新增多条记录
	 * 
	 * @param list
	 * @return
	 * @throws DataAccessException
	 */
	public int insert(List<PO> list) throws DataAccessException;

	/**
	 * 根据主键删除一条记录
	 * 
	 * @param pk
	 * @return
	 * @throws DataAccessException
	 */
	public int deleteByPK(PK pk) throws DataAccessException;

	/**
	 * 根据主键删除多条记录
	 * 
	 * @param pks
	 * @return
	 * @throws DataAccessException
	 */
	public int deleteByPKs(List<PK> pks) throws DataAccessException;

	/**
	 * 根据自定义whereStr条件语句删除记录，如"id='1' and name='a'"
	 * 
	 * @param whereStr
	 * @return
	 * @throws DataAccessException
	 */
	public int deleteByWhere(String whereStr) throws DataAccessException;

	/**
	 * 根据主键修改一条记录
	 * 
	 * @param t
	 * @return
	 * @throws DataAccessException
	 */
	public int updateByPK(PO t) throws DataAccessException;

	/**
	 * TODO 批量修改,参数map:列名=列值，keyList={1,2,3...}.
	 *
	 * @param map
	 * @return
	 * @throws DataAccessException
	 */
	public int update(Map<String, Object> map) throws DataAccessException;

	/**
	 * 根据自定义whereStr条件语句修改记录
	 * 
	 * @param map
	 *            参数map:列名=列值
	 * @param whereStr
	 *            "id='1' and name='a'"
	 * @return
	 * @throws DataAccessException
	 */
	public int updateByWhere(PO t, String whereStr) throws DataAccessException;

	/**
	 * 根据主键查询一条记录
	 * 
	 * @param pk
	 * @return
	 * @throws DataAccessException
	 */
	public PO selectByPK(PK pk) throws DataAccessException;

	/**
	 * 分页查询
	 * 
	 * @param qo
	 */
	// public void startPage(int pageNum, int pageSize);

	/**
	 * 分页查询
	 * 
	 * @param qo
	 */
	// public void startPage(BaseQO qo);

	/**
	 * 根据条件查询记录
	 * 
	 * @param qo
	 * @return
	 * @throws DataAccessException
	 */
	public List<PO> selectByAttr(QO qo) throws DataAccessException;

	/**
	 * 根据条件查询记录 分页查询
	 * 
	 * @param qo
	 * @return
	 * @throws DataAccessException
	 */
	public PageResult<PO> selectByAttrOnPage(QO qo) throws DataAccessException;

	/**
	 * 根据条件模糊查询记录
	 * 
	 * @param qo
	 * @return
	 * @throws DataAccessException
	 */
	// public List<PO> selectByLikeAttr(QO qo) throws DataAccessException;

	/**
	 * 根据自定义whereStr条件语句查询记录
	 * 
	 * @param whereStr
	 * @return
	 * @throws DataAccessException
	 */
	public List<PO> selectByWhere(String whereStr) throws DataAccessException;

	/**
	 * 根据自定义whereStr条件语句查询记录 分页查询
	 * 
	 * @param qo
	 * @param whereStr
	 * @return
	 * @throws DataAccessException
	 */
	public PageResult<PO> selectByWhereOnPage(QO qo, String whereStr) throws DataAccessException;

	/**
	 * 根据条件查询记录数
	 * 
	 * @param t
	 * @return
	 * @throws DataAccessException
	 */
	public int countByAttr(QO t) throws DataAccessException;

	/**
	 * 根据条件模糊查询记录数
	 * 
	 * @param t
	 * @return
	 * @throws DataAccessException
	 */
	// public int countByLikeAttr(QO t) throws DataAccessException;

	/**
	 * 根据自定义whereStr条件语句查询记录数
	 * 
	 * @param whereStr
	 * @return
	 * @throws DataAccessException
	 */
	public int countByWhere(String whereStr) throws DataAccessException;

```
#### 2.2.4、com.boco.rnop.framework.persistence.BaseDaoService(Service基类)
```


	@Autowired
	protected M mapper;

	/*
	 * (non-Javadoc)
	 * 
	 * @see
	 * com.boco.rnop.framework.persistence.IBaseService#insert(java.lang.Object)
	 */
	@Override
	public int insert(PO t) throws DataAccessException {
		return mapper.insert(t);
	}

	/*
	 * (non-Javadoc)
	 * 
	 * @see com.boco.rnop.framework.persistence.IBaseService#insert(java.util.List)
	 */
	@Override
	public int insert(List<PO> list) throws DataAccessException {
		for (PO t : list) {
			this.insert(t);
		}

		return list.size();
	}

	/*
	 * (non-Javadoc)
	 * 
	 * @see com.boco.rnop.framework.persistence.IBaseService#deleteByPK(java.io.
	 * Serializable)
	 */
	@Override
	public int deleteByPK(PK pk) throws DataAccessException {
		return mapper.deleteByPK(pk);
	}

	/*
	 * (non-Javadoc)
	 * 
	 * @see
	 * com.boco.rnop.framework.persistence.IBaseService#deleteByPKs(java.util.List)
	 */
	@Override
	public int deleteByPKs(List<PK> pks) throws DataAccessException {
		return mapper.deleteByPKs(pks);
	}

	/*
	 * (non-Javadoc)
	 * 
	 * @see
	 * com.boco.rnop.framework.persistence.IBaseService#deleteByWhere(java.lang.
	 * String)
	 */
	@Override
	public int deleteByWhere(String whereStr) throws DataAccessException {
		return mapper.deleteByWhere(whereStr);
	}

	/*
	 * (non-Javadoc)
	 * 
	 * @see
	 * com.boco.rnop.framework.persistence.IBaseService#updateByPK(java.lang.Object)
	 */
	@Override
	public int updateByPK(PO t) throws DataAccessException {
		return mapper.updateByPK(t);
	}

	/**
	 * TODO 批量修改,参数map:列名=列值，keyList={1,2,3...}.
	 *
	 * @param map
	 * @return
	 * @throws DataAccessException
	 */
	/*
	 * (non-Javadoc)
	 * 
	 * @see com.boco.rnop.framework.persistence.IBaseService#update(java.util.Map)
	 */
	@Override
	public int update(Map<String, Object> map) throws DataAccessException {
		return mapper.update(map);
	}

	/*
	 * (non-Javadoc)
	 * 
	 * @see
	 * com.boco.rnop.framework.persistence.IBaseService#updateByWhere(java.lang.
	 * Object, java.lang.String)
	 */
	@Override
	public int updateByWhere(PO t, String whereStr) throws DataAccessException {
		return mapper.updateByWhere(t, whereStr);
	}

	/*
	 * (non-Javadoc)
	 * 
	 * @see com.boco.rnop.framework.persistence.IBaseService#selectByPK(java.io.
	 * Serializable)
	 */
	@Override
	public PO selectByPK(PK pk) throws DataAccessException {
		return mapper.selectByPK(pk);
	}

	/**
	 * 分页查询
	 * 
	 * @param qo
	 */
	private void startPage(BaseQO qo) {
		PageHelper.startPage(qo.getPageIndex(), qo.getPageSize(), qo.isTotal());
	}

	/*
	 * (non-Javadoc)
	 * 
	 * @see com.boco.rnop.framework.persistence.IBaseService#selectByAttr(java.lang.
	 * Object)
	 */
	@Override
	public List<PO> selectByAttr(QO qo) throws DataAccessException {
		return mapper.selectByAttr(qo);
	}

	/*
	 * (non-Javadoc)
	 * 
	 * @see
	 * com.boco.rnop.framework.persistence.IBaseDaoService#selectByAttrOnPage(com.
	 * boco.rnop.framework.persistence.BaseQO)
	 */
	@Override
	public PageResult<PO> selectByAttrOnPage(QO qo) throws DataAccessException {
		this.startPage(qo);
		return new PageResult((Page<PO>) this.selectByAttr(qo));
	}

	/*
	 * (non-Javadoc)
	 * 
	 * @see
	 * com.boco.rnop.framework.persistence.IBaseService#selectByLikeAttr(java.lang.
	 * Object)
	 */
	/*
	 * @Override public List<PO> selectByLikeAttr(QO t) throws DataAccessException {
	 * return mapper.selectByLikeAttr(t); }
	 */

	/*
	 * (non-Javadoc)
	 * 
	 * @see
	 * com.boco.rnop.framework.persistence.IBaseService#selectByWhere(java.lang.
	 * String)
	 */
	@Override
	public List<PO> selectByWhere(String whereStr) throws DataAccessException {
		return mapper.selectByWhere(whereStr);
	}

	@Override
	public PageResult<PO> selectByWhereOnPage(QO qo, String whereStr) throws DataAccessException {
		this.startPage(qo);
		return new PageResult((Page<PO>) this.selectByWhere(whereStr));
	}

	/*
	 * (non-Javadoc)
	 * 
	 * @see com.boco.rnop.framework.persistence.IBaseService#countByAttr(java.lang.
	 * Object)
	 */
	@Override
	public int countByAttr(QO t) throws DataAccessException {
		return mapper.countByAttr(t);
	}

	/*
	 * (non-Javadoc)
	 * 
	 * @see
	 * com.boco.rnop.framework.persistence.IBaseService#countByLikeAttr(java.lang.
	 * Object)
	 */
	/*
	 * @Override public int countByLikeAttr(QO t) throws DataAccessException {
	 * return mapper.countByLikeAttr(t); }
	 */

	/*
	 * (non-Javadoc)
	 * 
	 * @see com.boco.rnop.framework.persistence.IBaseService#countByWhere(java.lang.
	 * String)
	 */
	@Override
	public int countByWhere(String whereStr) throws DataAccessException {
		return mapper.countByWhere(whereStr);
	}

```
#### 2.2.5、com.boco.rnop.framework.persistence.PageResult(分页查询结果对象)
```
    public PageResult(Page<E> page);
	/**
	 * 获取page 不建议使用
	 * 
	 * @return page page
	 */
	public Page<E> getPage()
	/**
	 * 获取查询记录
	 * 
	 * @return record record
	 */
	public List<E> getRecord() 
	/**
	 * 获取记录总数
	 * 
	 * @return size size
	 */
	public long getTotal() 
	/**
	 * 获取当前记录数
	 * 
	 * @return count count
	 */
	public long getCount()
	/**
	 * 转换为PageData
	 * 
	 * @return PageData
	 */
	public PageData<E> toPageData() 
	/**
	 * 转换为ResponseMessage
	 * 
	 * @return ResponseMessage
	 */
	public ResponseMessage toResponseMessage()	
```
3.PageHelper
----------
### 3.1、介绍
> Mybatis的一个插件，PageHelper，非常方便mybatis分页查询。
在github上仓库地址为：[Mybatis-PageHelper](https://github.com/pagehelper/Mybatis-PageHelper)

### 3.2、使用
```
extends BaseController
(可从request获取参数pageNum，pageSize，orderBy,前端需传参数)
setPageHelperParam();

原生：
PageHelper.startPage(pageNum, pageSize);

说明：
        //起始页码
        int pageNum ;
        //每页显示条数
        int pageSize ;
        //排序字段
        String orderBy;
        //是否查总数，默认查询总数count
        boolean count = true;
        //启用合理化时，如果pageNum<1会查询第一页，如果pageNum>pages会查询最后一页
        //禁用合理化时，如果pageNum<1或pageNum>pages会返回空数据
        boolean reasonable = true;
        //设置为true时，如果pageSize=0或者RowBounds.limit = 0就会查询出全部的结果
        //（相当于没有执行分页查询，但是返回结果仍然是Page类型）
        boolean pageSizeZero = true;
        //PageHelper.startPage(pageNum, pageSize, orderBy);
        PageHelper.startPage(pageNum, pageSize, count, reasonable, pageSizeZero);
        
分页结果：
		 List<TapCustomDictionaryPO> customDictionaryPOs=tapCustomDictionaryService.selectAll();
		 PageInfo<TapCustomDictionaryPO> info=new PageInfo<>(customDictionaryPOs);
```
### 3.3、示例sql
```
SELECT TMP_PAGE.*, ROWNUM ROW_ID FROM ( select param_value, user_id, param_name from TAP_CUSTOM_DICTIONARY ) TMP_PAGE WHERE ROWNUM <= ? 
```
### 3.4、示例分页结果数据
```
{
	"status": 0,
	"message": "ok",
	"data": {
		"pageNum": 1,
		"pageSize": 1,
		"size": 1,
		"startRow": 1,
		"endRow": 1,
		"total": 1,
		"pages": 1,
		"list": [{
			"paramValue": "3",
			"userId": "1",
			"paramName": "2"
		}],
		"prePage": 0,
		"nextPage": 0,
		"isFirstPage": true,
		"isLastPage": true,
		"hasPreviousPage": false,
		"hasNextPage": false,
		"navigatePages": 8,
		"navigatepageNums": [1],
		"navigateFirstPage": 1,
		"navigateLastPage": 1
	}
}
```
> [分页数据格式说明](https://blog.csdn.net/yibi4700/article/details/77411438)

二、配置组件
=============================
1、组件说明
-------------------
组成：ConfigService、ConfigClient、RabbitMQ、ConfigManager
```seq
Title: 配置组件配置刷新时序图
ConfigManager->Database: 修改数据库数据
ConfigManager->ConfigService: 发送/bus/refresh
ConfigService->RabbitMQ: 发送/bus/refresh
RabbitMQ->ConfigClient1: 发送/bus/refresh
RabbitMQ->ConfigClient2: 发送/bus/refresh
ConfigClient1->ConfigService: 获取最新配置参数
ConfigService->Database: 查询数据库
Database-->ConfigService: 返回查询结果
ConfigService-->ConfigClient1: 返回最新配置参数
ConfigClient2->ConfigService: 获取最新配置参数
ConfigService->Database: 查询数据库
Database-->ConfigService: 返回查询结果
ConfigService-->ConfigClient2: 返回最新配置参数
```
2、组件各组成
------------------------------------------------
### 2.1、ConfigService配置中心
- framework-config-1.0.0.jar
- pom.xml添加依赖
```
		<dependency>
			<groupId>org.springframework.cloud</groupId>
			<artifactId>spring-cloud-config-server</artifactId>
			<version>1.4.3.RELEASE</version>
		</dependency>
		<dependency>
			<groupId>org.springframework.cloud</groupId>
			<artifactId>spring-cloud-config-client</artifactId>
			<version>1.4.3.RELEASE</version>
		</dependency>
		<dependency>
			<groupId>org.springframework.boot</groupId>
			<artifactId>spring-boot-starter-data-jpa</artifactId>
		</dependency>
		<dependency>
			<groupId>org.springframework.cloud</groupId>
			<artifactId>spring-cloud-starter-bus-amqp</artifactId>
			<version>1.3.3.RELEASE</version>
		</dependency>		
```
- application.yml配置
```
#配置参数数据源
spring.datasource.url: jdbc:oracle:thin:@10.10.2.31:1521:test 
spring.datasource.username: niosdb_ah 
spring.datasource.password: niosdb_ah 
spring.datasource.driver-class-name: oracle.jdbc.driver.OracleDriver
spring.cloud.config.label: master
spring.cloud.config.server.jdbc: true
spring.cloud.config.server.jdbc.sql: SELECT PROP_KEY as KEY,PROP_VALUE as VALUE from TV3_SYS_PROPERTIES where  PROP_APPLICATION = ? and PROP_PROFILE like ? and PROP_LABEL like ? 
#rabbitmq配置
spring.rabbitmq.host: 10.10.2.191
spring.rabbitmq.port: 5672
spring.rabbitmq.username: admin
spring.rabbitmq.password: admin 
```
- Http API访问示例
> http://10.10.2.191:8110/网优3.0框架/portal/dev
返回结果：
{"name":"网优3.0框架","profiles":["portal"],"label":"dev","version":null,"state":null,"propertySources":[{"name":"网优3.0框架-portal","source":{"spring.datasource.url":"jdbc:oracle:thin:@127.0.0.1:1521:orcl1","spring.datasource.oracle.url":"jdbc:oracle:thin:@10.10.2.31:1521:test","spring.datasource.oracle.driver-class-name":"oracle.jdbc.driver.OracleDriver","spring.datasource.oracle.username":"niosdb_ah","spring.datasource.oracle.password":"niosdb_ah","value":"123"}}]}
`注意：二级选项可填多个，用‘，’隔开`

### 2.2、RabbitMQ（Spring Cloud Bus）
> RabbitMQ是一个由erlang开发的AMQP(Advanved Message Queue)的开源实现。需要服务器安装部署。

### 2.3、ConfigClient配置客户端
- pom.xml添加依赖
```
		<dependency>
			<groupId>org.springframework.cloud</groupId>
			<artifactId>spring-cloud-config-server</artifactId>
			<version>1.4.3.RELEASE</version>
		</dependency>
		<dependency>
            <groupId>org.springframework.cloud</groupId>
            <artifactId>spring-cloud-config-client</artifactId>
            <version>1.4.3.RELEASE</version>
		</dependency>
		<dependency>
			<groupId>org.springframework.cloud</groupId>
			<artifactId>spring-cloud-starter-bus-amqp</artifactId>
			<version>1.3.3.RELEASE</version>
		</dependency>
		<dependency>
			<groupId>org.springframework.cloud</groupId>
			<artifactId>spring-cloud-starter-config</artifactId>
			<version>1.4.3.RELEASE</version>
		</dependency>
```
- application.yml配置参数
```
spring.cloud.config.name: 参数管控
spring.cloud.config.profile: 是否部署指令平台
spring.cloud.config.label: -1
spring.cloud.config.uri: http://127.0.0.1:8111/
#spring.cloud.config.discovery.serviceId: framework-security-config-files-service
## 刷新时，关闭安全验证
management.security.enabled: false
## 开启消息跟踪
spring.cloud.bus.trace.enabled: true
spring.rabbitmq.host: 10.10.2.191
spring.rabbitmq.port: 5672
spring.rabbitmq.username: admin
spring.rabbitmq.password: admin 
```
- 配置参数使用
```
    @Value("${name}")
    private  String name;
```
- 通过配置门面类获取参数
```
ConfigUtil.getConfigValues(...)
```


三、日志组件
====================================
1、组件说明
-------------------------------
- framework-common-1.0.0.jar
- 基于ELK（实时日志分析平台）
1. Elasticsearch是个开源分布式搜索引擎，它的特点有：分布式，零配置，自动发现，索引自动分片，索引副本机制，restful风格接口，多数据源，自动搜索负载等。
2. Logstash是一个完全开源的工具，他可以对你的日志进行收集、过滤，并将其存储供以后使用（如，搜索）。
3. Kibana 也是一个开源和免费的工具，它Kibana可以为 Logstash 和 ElasticSearch 提供的日志分析友好的 Web 界面，可以帮助您汇总、分析和搜索重要数据日志。
Kibana界面：
![微信图片_20180510160408.jpg-43.4kB][3]

`Elasticsearch、Logstash、Kibana都需要在服务器安装部署`

- 服务端使用Logback采集日志,Logback是由log4j创始人设计的又一个开源日志组件
- Logback配置文件logback-spring.xml
```
<?xml version="1.0" encoding="UTF-8"?>
<configuration>
	<include resource="org/springframework/boot/logging/logback/defaults.xml" />
	<!--获取bootstrap.yml配置文件中的spring.application.name配置参数 -->
	<springProperty scope="context" name="springAppName"
		source="spring.application.name" />
	<!--自定义 日志片段 -->
	<conversionRule conversionWord="logCategoryConvert"
		converterClass="com.boco.rnop.framework.common.log.converter.LogCategoryConvert" />
	<!--自定义 日志片段 -->
	<conversionRule conversionWord="logModuleConvert"
		converterClass="com.boco.rnop.framework.common.log.converter.LogModuleConvert" />
	<!--自定义 日志片段 -->
	<conversionRule conversionWord="logFunctionConvert"
		converterClass="com.boco.rnop.framework.common.log.converter.LogFunctionConvert" />
	<!--自定义 日志片段 -->
	<conversionRule conversionWord="logMessageConvert"
		converterClass="com.boco.rnop.framework.common.log.converter.LogMessageConvert" />

	<!-- 日志文件在工程中的输出位置 -->
	<property name="LOG_FILE" value="${BUILD_FOLDER:-target}/${springAppName}" />


	<!-- 控制台输出 -->
	<appender name="console" class="ch.qos.logback.core.ConsoleAppender">
		<filter class="ch.qos.logback.classic.filter.ThresholdFilter">
			<level>DEBUG</level>
		</filter>
		<!-- 日志输出编码 -->
		<encoder>
			<!-- 日志输出格式 -->
			<pattern>%d{yyyy-MM-dd HH:mm:ss.SSS} [%thread] %-5level %logger -
				%msg%n</pattern>
			<charset>utf8</charset>
		</encoder>
	</appender>

	<!-- 输出的json格式的日志文件Appender -->
	<appender name="logstashFile"
		class="ch.qos.logback.core.rolling.RollingFileAppender">
		<file>${LOG_FILE}.json</file>
		<rollingPolicy class="ch.qos.logback.core.rolling.TimeBasedRollingPolicy">
			<fileNamePattern>${LOG_FILE}.json.%d{yyyy-MM-dd}.gz</fileNamePattern>
			<maxHistory>7</maxHistory>
		</rollingPolicy>
		<encoder
			class="net.logstash.logback.encoder.LoggingEventCompositeJsonEncoder">
			<providers>
				<timestamp>
					<timeZone>UTC</timeZone>
				</timestamp>
				<pattern>
					<pattern>
						{
						"level": "%level",
						"springAppName": "${springAppName:-}",
						"pid":
						"${PID:-}",
						"thread": "%thread",
						"class": "%logger",
						"logCategoryConvert": "%logCategoryConvert",
						"logModuleConvert":
						"%logModuleConvert",
						"logFunctionConvert": "%logFunctionConvert",
						"logMessageConvert": "%logMessageConvert",
						"message": "%message"
						}
					</pattern>
				</pattern>
			</providers>
		</encoder>
	</appender>

	<!-- 向logstash输出的JSON格式的Appender -->
	<appender name="logstash"
		class="net.logstash.logback.appender.LogstashTcpSocketAppender">
		<!-- logstash的IP和端口号 -->
		<destination>10.10.2.191:4561</destination>
		<!-- 日志输出编码 -->
		<encoder
			class="net.logstash.logback.encoder.LoggingEventCompositeJsonEncoder">
			<providers>
				<timestamp>
					<timeZone>UTC</timeZone>
				</timestamp>
				<pattern>
					<pattern>
						{
						"level": "%level",
						"springAppName": "${springAppName:-}",
						"pid": "${PID:-}",
						"thread": "%thread",
						"class": "%logger",
						"logCategoryConvert": "%logCategoryConvert",
						"logModuleConvert":
						"%logModuleConvert",
						"logFunctionConvert": "%logFunctionConvert",
						"logMessageConvert": "%logMessageConvert",
						"message": "%message"
						}
					</pattern>
				</pattern>
			</providers>
		</encoder>
	</appender>

	<!-- name包必须能够扫描到所有类，包括启动类 -->
	<logger name="com.boco.rnop" level="DEBUG" additivity="false">
		<appender-ref ref="logstashFile" />
		<appender-ref ref="console" />
		<appender-ref ref="logstash" />
	</logger>
	<!-- 日志输出级别 -->
	<root level="INFO">
		<appender-ref ref="logstashFile" />
		<appender-ref ref="console" />
		<appender-ref ref="logstash" />
	</root>
</configuration> 
```
- 日志分类：操作日志，调试日志，链路日志
2、开发使用
----------------------
### 2.1、链路日志
- pom.xml添加依赖
```
		<dependency>
			<groupId>org.springframework.cloud</groupId>
			<artifactId>spring-cloud-starter-zipkin</artifactId>
			<version>RELEASE</version>
		</dependency>
```
- application.yml添加Zipkin Server配置参数
```
spring:
  zipkin:
    base-url: http://10.10.2.191:8120  #Zipkin Server地址
  sleuth:
    sampler:
      percentage: 1.0 #将一定概率的数据上传链路
```
### 2.2、操作日志
#### 2.2.1、pom.xml添加依赖（父项目中已添加）
```
		<dependency>
			<groupId>com.boco.rnop.framework</groupId>
			<artifactId>framework-common</artifactId>
			<version>${boco.framework.version}</version>
		</dependency>
```
#### 2.2.2、使用
![捕获.PNG-12.4kB][4]

##### 2.2.2.1、 使用日志注解

```
@SystemHandleLogInfo(logModule="系统日志模块",logFunction="insert",logMessage="新增操作日志",databaseAccessType=DatabaseAccessType.READ,logLevel=LogLevel.INFO)
```
##### 2.2.2.2、 使用org.slf4j.Logger
```
private Logger logger=LoggerFactory.getLogger(TapCustomDictionaryController.class);

logger.info(SystemLogFormater.format(SystemLogFormater.LOG_CATEGORY_DEBUG, "test", "test", "test"));

logger.info(SystemLogFormater.formatAndWriteDatabase(logCategory, logModule, logFunction, logMessage, handleDateTimeMillis, handleConsumingTime, serviceName, userId, userName);
```
### 2.3、调试日志
- pom.xml添加依赖（父项目中已添加）
```
		<dependency>
			<groupId>com.boco.rnop.framework</groupId>
			<artifactId>framework-common</artifactId>
			<version>${boco.framework.version}</version>
		</dependency>
```
- 使用
使用org.slf4j.Logger
```
private Logger logger=LoggerFactory.getLogger(TapCustomDictionaryController.class);

logger.info(SystemLogFormater.format(SystemLogFormater.LOG_CATEGORY_DEBUG, "test", "test", "test"));
```
补充：
`Mybatis SQL日志：`
```
mybatis-config.xml配置文件中在<settings>中添加
<setting name="logImpl" value="STDOUT_LOGGING" />
```
四、项目实战和部署
====================
1、项目实战
------------------
### 1.1、安装配置开发环境及java基础学习
- 安装jdk1.8,配置java环境变量
- 安装Eclipse,选择Eclipse Java EE IDE for Web Developers版本
- 学习了解 [java基础](http://www.runoob.com/java/java-tutorial.html)
- Maven仓库 [Maven公共库](http://mvnrepository.com/)

### 1.2、maven本地仓库与pom.xml依赖说明
pom.xml依赖
```
		<dependency>
			<groupId>boco.rnop.valuearea</groupId>
			<artifactId>boco.rnop.valuearea.entity</artifactId>
			<version>0.0.1-SNAPSHOT</version>
		</dependency>
```
maven本地仓库目录默认：C:\Users\Administrator\.m2\repository
> 根据pom.xml中的依赖声明，会在maven本地库中查找依赖jar包
```
<groupId>boco.rnop.valuearea</groupId>
<artifactId>boco.rnop.valuearea.entity</artifactId>
```
![捕获.PNG-27.2kB][5]
```
<version>0.0.1-SNAPSHOT</version>
```
![捕获.PNG-21.9kB][6]

![捕获.PNG-29.4kB][7]

`注意：eclipse项目会优先在工作空间中查找maven依赖`

- 在maven本地仓库添加框架所依赖的jar
> 将框架打包后的文件夹复制到maven本地仓库目录下
![捕获.PNG-2kB][8]
![捕获.PNG-10.7kB][9]
![捕获.PNG-41kB][10]

### 1.3、新建maven项目

#### 1.3.1、 maven项目架构
![捕获.PNG-10.4kB][11]


- client maven项目

> 服务访问类，专服务于service访问；里面采用feign调用service，且集成ribbon和hystrix，web服务客户端和Hystrix熔断器


- entity maven项目

> 类库，存放持久化对象和查询对象

- service maven项目

> service  应用程序，提供比较原子的业务服务，可直连数据源进行数据操作，对外以Rest形式提供服务，等同于集中化支撑平台中persistence+domain+service
          mapper  ----  idao       java中不存在dao
          service   ----  idaoservice
          serviceimpl ---- daoservice

- webserver maven项目

> 应用程序，直接面向页面（Web）的应用服务，类似于集中化支撑平台中ui层

- web  maven项目

> ui页面，以单页面形式开发，直接访问webserver提供的服务


```seq
Title: 项目调用时序图
Web->WebService: 请求获取用户信息
WebService->Client: 调用Client提供的api接口
Client->Service: 获取用户信息
Service-->WebService: 返回用户信息
WebService-->>Web: 返回Rest格式用户信息
```


#### 1.3.2、 选择maven项目创建目录

![捕获.PNG-39kB][12]

#### 1.3.3、 填写maven项目配置

- client maven项目
```
	<parent>
		<groupId>com.boco.rnop.framework</groupId>
		<artifactId>framework-parent-client-pom</artifactId>
		<version>1.0.0</version>
	</parent>
```

![捕获.PNG-41.2kB][13]

- entity maven项目
```
	<parent>
		<groupId>com.boco.rnop.framework</groupId>
		<artifactId>framework-parent-entity-pom</artifactId>
		<version>1.0.0</version>
	</parent>
```

![捕获.PNG-47.1kB][14]

-  service maven项目
```
	<parent>
		<groupId>com.boco.rnop.framework</groupId>
		<artifactId>framework-parent-service-pom</artifactId>
		<version>1.0.0</version>
	</parent>
```

![捕获.PNG-33.4kB][15]

- webserver maven项目
```
	<parent>
		<groupId>com.boco.rnop.framework</groupId>
		<artifactId>framework-parent-ui-pom</artifactId>
		<version>1.0.0</version>
	</parent>
```

![捕获.PNG-29.6kB][16]

- web vue项目
> vue项目

### 1.4、配置maven项目pom.xml
- client maven项目


`pom.xml添加新建项目的entity依赖`


```
	<dependencies>
		<dependency>
			<groupId>boco.rnop.valuearea</groupId>
			<artifactId>boco.rnop.valuearea.entity</artifactId>
			<version>0.0.1-SNAPSHOT</version>
		</dependency>
	</dependencies>
```
- entity maven项目
```
无
```
-  service maven项目

`pom.xml添加新建项目的entity依赖`

```
	<dependencies>
		<dependency>
			<groupId>boco.rnop.valuearea</groupId>
			<artifactId>boco.rnop.valuearea.entity</artifactId>
			<version>0.0.1-SNAPSHOT</version>
		</dependency>
	</dependencies>		
```
- webserver maven项目


`pom.xml添加新建项目的entity、client依赖`


```
	<dependencies>
		<dependency>
			<groupId>boco.rnop.valuearea</groupId>
			<artifactId>boco.rnop.valuearea.client</artifactId>
			<version>0.0.1-SNAPSHOT</version>
		</dependency>
		<dependency>
			<groupId>boco.rnop.valuearea</groupId>
			<artifactId>boco.rnop.valuearea.entity</artifactId>
			<version>0.0.1-SNAPSHOT</version>
		</dependency>
	</dependencies>
```
### 1.5、后端开发
目录结构说明：
`注意：项目、包的命名仅供参考！`

#### 1.5.1、client maven项目(web服务客户端和Hystrix熔断器)

![微信截图_20180506120502.png-25.9kB][17]

```
package com.boco.rnop.valuearea.client;

import org.springframework.cloud.netflix.feign.FeignClient;
import org.springframework.web.bind.annotation.RequestMapping;

import com.boco.rnop.valuearea.client.hystrix.TapCustomDictionaryClientHystrix;

@FeignClient(value = "BOCO-VALUEAREA-SERVICE", fallback = TapCustomDictionaryClientHystrix.class)
public interface ITapCustomDictionaryClient {
	@RequestMapping(value = "/tapCustomDictionary/selectAll")
	public String selectAll();
}
```
>定义@FeignClient客户端，
@FeignClient指定service服务名，熔断备用回调类
@RequestMapping需要与service服务端controller一一对应
```
package com.boco.rnop.valuearea.client.hystrix;

import org.springframework.stereotype.Component;

import com.boco.rnop.framework.common.ResponseMessage;
import com.boco.rnop.framework.common.util.JsonUtil;
import com.boco.rnop.valuearea.client.ITapCustomDictionaryClient;
@Component
public class TapCustomDictionaryClientHystrix implements ITapCustomDictionaryClient{

	@Override
	public String selectAll() {
		// TODO Auto-generated method stub
		return JsonUtil.toJson(ResponseMessage.Failed("请求出现错误"));
	}

}

```

> 实现boco.rnop.valuearea.client包中的接口，当服务请求出现问题时会调用

#### 1.5.2、entity maven项目(数据访问所需实体类库)

![1525579744(1).png-25.1kB][18]
```
package com.boco.rnop.valuearea.entity.po;

public class TapCustomDictionaryPO {

	/**  */
	private String paramValue;
	/**  */
	private String userId;
	/**  */
	private String paramName;

	public String getParamValue() {
		return paramValue;
	}

	public void setParamValue(String paramValue) {
		this.paramValue = paramValue;
	}

	public String getUserId() {
		return userId;
	}

	public void setUserId(String userId) {
		this.userId = userId;
	}

	public String getParamName() {
		return paramName;
	}

	public void setParamName(String paramName) {
		this.paramName = paramName;
	}
}
```
>PO:数据查询返回结果实体类
QO:数据查询条件实体类
get、set方法可批量生成

`注意：java命名规则，类名首字母大写，属性、方法名首字母小写`

#### 1.5.3、service maven项目(Service服务，提供Http请求服务)

![微信截图_20180506121532.png-31.1kB][19]

##### 1.5.3.1、启动类：
```
package com.boco.rnop.framework.portal.service;

import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.EnableAutoConfiguration;
import org.springframework.boot.autoconfigure.SpringBootApplication;
import org.springframework.cloud.client.discovery.EnableDiscoveryClient;
import org.springframework.cloud.netflix.feign.EnableFeignClients;
import org.springframework.context.annotation.ComponentScan;

import com.github.pagehelper.autoconfigure.PageHelperAutoConfiguration;

/**
 * Created by IntelliJ IDEA. User: duqi Date: 2017/3/19 Time: 16:59
 */
@EnableDiscoveryClient // 用于启动服务发现功能
@EnableFeignClients // 用于启动Fegin功能
// @EnableZipkinServer // 开启日志收集
@SpringBootApplication
@EnableAutoConfiguration(exclude = { PageHelperAutoConfiguration.class })
@ComponentScan(basePackages = { "com.boco.rnop" })
public class ServiceApplication {

	public static void main(String[] args) {
		SpringApplication.run(ServiceApplication.class);
	}
}

```
>@EnableAutoConfiguration(exclude = { PageHelperAutoConfiguration.class })
禁止PageHelperAutoConfiguration自动加载配置参数
@ComponentScan(basePackages = { "com.boco.rnop" })
定义@Component自动加载注解扫描范围

##### 1.5.3.2、controller层:
```
package com.boco.rnop.valuearea.service.controller;

import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RestController;

import com.boco.rnop.framework.common.ResponseMessage;
import com.boco.rnop.framework.common.log.annotation.SystemHandleLogInfo;
import com.boco.rnop.framework.common.log.annotation.SystemHandleLogInfo.DatabaseAccessType;
import com.boco.rnop.framework.common.log.annotation.SystemHandleLogInfo.LogLevel;
import com.boco.rnop.framework.common.log.util.SystemLogFormater;
import com.boco.rnop.framework.common.util.JsonUtil;
import com.boco.rnop.framework.persistence.BaseController;
import com.boco.rnop.valuearea.service.service.ITapCustomDictionaryService;


@RestController
@RequestMapping(value = "/tapCustomDictionary")
public class TapCustomDictionaryController extends BaseController{
	private Logger logger=LoggerFactory.getLogger(TapCustomDictionaryController.class);
	
	@Autowired
	private ITapCustomDictionaryService tapCustomDictionaryService;

	
	@RequestMapping(value = "/selectAll")
	@SystemHandleLogInfo(logModule="test",logFunction="test",logMessage="test",databaseAccessType=DatabaseAccessType.READ,logLevel=LogLevel.DEBUG)
	public String selectAll() throws Exception {
		setPageHelperParam();
		logger.info(SystemLogFormater.format(SystemLogFormater.LOG_CATEGORY_DEBUG, "test", "test", "test"));
		return JsonUtil.toJson(ResponseMessage.Success(tapCustomDictionaryService.selectAll()));
	}

}

```
>RestService服务controller层，定义对外暴露的请求路径
@RestController
声明是RestController
@RequestMapping(value = "/tapCustomDictionary")
定义请求一级路径
@Autowired
spring自动注入注解（需接口类型）
@RequestMapping(value = "/selectAll")
定义请求二级路径
@SystemHandleLogInfo(logModule="test",logFunction="test",logMessage="test",databaseAccessType=DatabaseAccessType.READ,logLevel=LogLevel.DEBUG)
自定义操作日志注解，通过AOP切面类可获取操作信息，输出日志

##### 1.5.3.3、mapper层：
```
package com.boco.rnop.valuearea.service.mapper;

import java.util.List;

import com.boco.rnop.valuearea.entity.po.TapCustomDictionaryPO;

public interface TapCustomDictionaryMapper {

	public List<TapCustomDictionaryPO> selectAll();

}
```
> 与mybatis.mapper.oracle目录下的xml文件sql一一对应

##### 1.5.3.4、service接口层
```
package com.boco.rnop.valuearea.service.service;

import java.util.List;

import com.boco.rnop.valuearea.entity.po.TapCustomDictionaryPO;
public interface ITapCustomDictionaryService {
	public List<TapCustomDictionaryPO> selectAll();
}

```
> RestService服务service层，定义服务所需接口类

##### 1.5.3.5、service.impl服务实现层
```
package com.boco.rnop.valuearea.service.service.impl;

import java.util.List;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;

import com.boco.rnop.valuearea.entity.po.TapCustomDictionaryPO;
import com.boco.rnop.valuearea.service.mapper.TapCustomDictionaryMapper;
import com.boco.rnop.valuearea.service.service.ITapCustomDictionaryService;
@Service
public class TapCustomDictionaryService implements ITapCustomDictionaryService {

	@Autowired
	private TapCustomDictionaryMapper tapCustomDictionaryMapper;

	@Override
	public List<TapCustomDictionaryPO> selectAll() {
		return tapCustomDictionaryMapper.selectAll();
	}

}

```
> RestService服务service层，实现服务接口类
@Service
声明是Service实现类
implements ITapCustomDictionaryService
实现Service接口类
@Autowired
spring自动注入注解（需接口类型）注入Mapper,可调用定义的sql查询语句，可定义多个



##### 1.5.3.6、src/main/resources/mybatis/mapper SQL xml文件
```
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper
	namespace="com.boco.rnop.valuearea.service.mapper.TapCustomDictionaryMapper">
	<resultMap id="TapCustomDictionary"
		type="com.boco.rnop.valuearea.entity.po.TapCustomDictionaryPO">
		<result column="param_value" property="paramValue" />
		<result column="user_id" property="userId" />
		<result column="param_name" property="paramName" />
	</resultMap>

	<sql id="Base_Column_List">
		param_value,
		user_id,
		param_name
	</sql>

	<select id="selectAll" resultMap="TapCustomDictionary" >
		select
		<include refid="Base_Column_List" />
		from TAP_CUSTOM_DICTIONARY
	</select>

</mapper>	
```
> [Mapper XML 文件 简介](http://www.mybatis.org/mybatis-3/zh/sqlmap-xml.html)
存放mybatis SQLMapping映射文件
<mapper
	namespace="com.boco.rnop.valuearea.service.mapper.TapCustomDictionaryMapper">
	指向TapCustomDictionaryMapper.java
<resultMap id="TapCustomDictionary"
		type="com.boco.rnop.valuearea.entity.po.TapCustomDictionaryPO">
声明语句返回结果字段名与实体类属性的映射关系
`<sql id="Base_Column_List">`
 定义固定的sql语句段
 
##### 1.5.3.7、src/test/java 单元测试
 
```
package com.boco.rnop.valuearea.service.controller;


import java.io.UnsupportedEncodingException;

import org.junit.Before;
import org.junit.Test;
import org.junit.runner.RunWith;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.test.context.SpringBootTest;
import org.springframework.http.MediaType;
import org.springframework.mock.web.MockHttpServletRequest;
import org.springframework.mock.web.MockHttpSession;
import org.springframework.test.context.junit4.SpringRunner;
import org.springframework.test.web.servlet.MockMvc;
import org.springframework.test.web.servlet.request.MockHttpServletRequestBuilder;
import org.springframework.test.web.servlet.request.MockMvcRequestBuilders;
import org.springframework.test.web.servlet.setup.MockMvcBuilders;
import org.springframework.web.context.WebApplicationContext;

import com.boco.rnop.valuearea.service.ValueareaServiceApp;

@RunWith(SpringRunner.class)
@SpringBootTest(classes = ValueareaServiceApp.class)
public class TapCustomDictionaryControllerTest {
	@Autowired
	private WebApplicationContext webApplicationContext;

	@Autowired
	private MockHttpSession mockHttpSession;

	@Autowired
	private MockHttpServletRequest mockHttpServletRequest;

	private MockMvc mockMvc;

	@Before
	public void before() {
		this.mockMvc = MockMvcBuilders.webAppContextSetup(this.webApplicationContext).build();
	}

	@Test
	public void testSelectAll() throws UnsupportedEncodingException, Exception {
		MockHttpServletRequestBuilder requestBuilder = MockMvcRequestBuilders.get("/tapCustomDictionary/selectAll")
				.accept(MediaType.APPLICATION_JSON_UTF8);
		String result = mockMvc.perform(requestBuilder).andReturn().getResponse().getContentAsString();
		System.out.println(result);
	}

	@Test
	public void testPostSelectAll() throws UnsupportedEncodingException, Exception {
		ValueEvaluationParam param = new ValueEvaluationParam();
	param.setParamName("test1");
	param.setParamValue("test2");
	param.setUserId("test3");
	ObjectMapper mapper = new ObjectMapper();
	System.out.println(mapper.writeValueAsString(param));
	MockHttpServletRequestBuilder requestBuilder = MockMvcRequestBuilders.post("/ValueEvaluation/AddSetting")
			.content(mapper.writeValueAsString(param)).contentType(MediaType.APPLICATION_JSON).accept(MediaType.APPLICATION_JSON);
	String result = mockMvc.perform(requestBuilder).andReturn().getResponse().getContentAsString();
	System.out.println(result);
	}
	
}
```

>@SpringBootTest(classes = ValueareaServiceApp.class)
声明启动类

##### 1.5.3.8、src/main/resources yaml配置文件

> application.yml
```
server:
  port: 8550 #端口号

eureka:
  client:
    serviceUrl:
      defaultZone: http://127.0.0.1:8100/eureka/

feign.hystrix.enabled: true
spring:
  zipkin:
    base-url: http://10.10.2.191:8120  #Zipkin Server地址
  sleuth:
    sampler:
      percentage: 1.0 #将一定概率的数据上传链路
  
# 数据库配置
  datasource:
    oracle:
      driver-class-name: oracle.jdbc.driver.OracleDriver
      url: jdbc:oracle:thin:@10.221.177.4:1521:niosserver
      username: niosdb
      password: niosdb
    informix:
      driver-class-name: com.informix.jdbc.IfxDriver
      url: jdbc:informix-sqli://10.10.1.91:8001/niosdbhlj:informixserver=niosserver201;Database=sysmaster
      username: informix
      password: informix 
    impala: 
      driver-class-name: com.informix.jdbc.IfxDriver
      url: jdbc:informix-sqli://10.10.1.91:8001/niosdbhlj:informixserver=niosserver201;Database=niosdbhlj;newcodeset=gbk,8859-1,819;Database locale=en_US.819;ClientLocale=en_us.8859-1;
      username: informix
      password: informix
    default1:
      db-type: informix
      driver-class-name: com.informix.jdbc.IfxDriver
      url: jdbc:informix-sqli://10.10.1.91:8001/niosdbhlj:informixserver=niosserver201;Database=niosdbhlj;newcodeset=gbk,8859-1,819;Database locale=en_US.819;ClientLocale=en_us.8859-1;
      username: informix
      password: informix 
    default: 
      db-type: oracle #网优数据库类型 oracle/informix
      driver-class-name: oracle.jdbc.driver.OracleDriver
      url: jdbc:oracle:thin:@10.10.2.31:1521:test
      username: niosdb_ah
      password: niosdb_ah
   
  data:
    solr: 
      host: http://10.10.2.191:8983/solr
    hbase: 
      quorum: 10.60.0.7:2181
      rootDir: E:\\Hadoop"
      nodeParent: 

hbase:
  zookeeper:
    quorum: 10.60.0.7:2181
        
# 打印日志
logging:
  level:
    root: INFO
    org.springframework.web: DEBUG
    org.hibernate: INFO
    org.hibernate.type.descriptor.sql.BasicBinder: TRACE
    org.hibernate.type.descriptor.sql.BasicExtractor: TRACE
    com.springms: DEBUG
boco-rnop:  
    common: 
      email: 
        host: pop.boco.com.cn
        from: guojianfeng@boco.com.cn
        password: xxxx

#####################################################################################################
# mybatis mapper xml 配置
mybatis:
  # mybatis.type-aliases-package：指定domain类的基包，即指定其在*Mapper.xml文件中可以使用简名来代替全类名
  #type-aliases-package:
#  mapper-locations: classpath:mybatis/mapper/*.xml  
  config-location: classpath:mybatis/mybatis-config.xml
#####################################################################################################
# 上传下载配置
load:
  commonpath: test
  ftp:
    server: 10.10.2.202
    port: 21
    username: ftptest01
    password: ftptest01
    basepath: /tt
  tempath: C:/Users/liuhaiyun/Downloads
  fileload: ftploadfile

```
> bootstrap.yml
```
spring:
  application:
    name: boco-phm-service
```

#### 1.5.4、webserver maven项目(前端web页面服务)

![微信截图_20180506121823.png-31.5kB][20]
com.boco.rnop.valuearea.webserver:
>ValueareaWebServiceApp.java服务启动类
```
package com.boco.rnop.valuearea.webserver;

import org.springframework.boot.SpringApplication;
import org.springframework.boot.actuate.autoconfigure.EndpointAutoConfiguration;
import org.springframework.boot.autoconfigure.SpringBootApplication;
import org.springframework.boot.autoconfigure.session.SessionAutoConfiguration;
import org.springframework.cloud.client.discovery.EnableDiscoveryClient;
import org.springframework.cloud.netflix.feign.EnableFeignClients;
import org.springframework.context.annotation.ComponentScan;

import com.boco.rnop.framework.parent.ui.EnableFrameworkClient;

@SpringBootApplication(exclude = { SessionAutoConfiguration.class ,EndpointAutoConfiguration.class})
@EnableDiscoveryClient
@EnableFrameworkClient
@EnableFeignClients(basePackages = { "com.boco.rnop.valuearea.client","com.boco.rnop.valuearea.client.hystrix"})
@ComponentScan(value="com.boco.rnop")
public class ValueareaWebServiceApp {
	public static void main(String[] args) {
		SpringApplication.run(ValueareaWebServiceApp.class, args);
		System.out.println("【【【【【【 ValueareaWebService】】】】】】已启动.");
	}
}
 
```
> @SpringBootApplication(exclude = { SessionAutoConfiguration.class ,EndpointAutoConfiguration.class})
排除参数的自动加载
@EnableFeignClients(basePackages = { "com.boco.rnop.valuearea.client","com.boco.rnop.valuearea.client.hystrix"})
@ComponentScan(value="com.boco.rnop.valuearea")
声明fegin client的包
@ComponentScan(value="com.boco.rnop")
声明自动加载扫描范围

com.boco.rnop.valuearea.webserver.controller:
>RestService服务controller层，面向前端页面
```
package com.boco.rnop.valuearea.webserver.controller;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RestController;

import com.boco.rnop.valuearea.client.ITapCustomDictionaryClient;

@RestController
@RequestMapping(value = "/tapCustomDictionary")
public class TapCustomDictionaryController {

	@Autowired
	private ITapCustomDictionaryClient tapCustomDictionaryClient;

	@RequestMapping(value = "/selectAll")
	public String selectAll() {
		return tapCustomDictionaryClient.selectAll();
	}

}

```
> @RestController
声明RestController
@RequestMapping(value = "/tapCustomDictionary")
定义一级请求路径
@Autowired
private ITapCustomDictionaryClient tapCustomDictionaryClient;
自动注入tapCustomDictionaryClient feign客户端
@RequestMapping(value = "/selectAll")
定义二级请求路径


```seq
Title: 时序图
Web->Web: 页面跳转
Web->WebService.UserInfoController: 获取用户信息
WebService.UserInfoController->Client:UserInfoService服务未找到
Client->ClientHystrix:调用服务异常接口
ClientHystrix-->WebService.UserInfoController:服务异常信息
WebService.UserInfoController-->Web:服务异常信息
Web->WebService.UserInfoController: 获取用户信息
WebService.UserInfoController->Client:调用UserInfoService服务查询接口
Client->Service.Controller:调用Controller层请求接口
Service.Controller->Service.Service:调用Service
Service.Service->Service.Service.impl:调用Service.impl
Service.Service.impl->Service.Mapper:调用Mapper
Service.Mapper->Service.Mapper.xml:执行Mapper.xml中的sql语句
Service.Mapper.xml-->Web:用户信息
```
2、项目部署
---------
jar包部署
>java -Xms64m -Xmx256m -jar ./simple-service-0.0.1.jar --server.port=7085 

> java -Dfile.encoding=utf-8 -jar `指定文件编码格式启动`

`yml配置文件中配置的参数启动时均可通过‘--’配置覆盖启动`


  [1]: http://static.zybuluo.com/zhanghuanliang/8nlmp2szo3uunckvq5fqmv8h/image.png
  [2]: http://static.zybuluo.com/zhanghuanliang/er2o6jaaw57bkkw0ljrx93yz/image.png
  [3]: http://static.zybuluo.com/zhanghuanliang/e68645xxf9bllk20qlpbv5kb/%E5%BE%AE%E4%BF%A1%E5%9B%BE%E7%89%87_20180510160408.jpg
  [4]: http://static.zybuluo.com/zhanghuanliang/ppyzqmqxez6p0n88pnp603zh/%E6%8D%95%E8%8E%B7.PNG
  [5]: http://static.zybuluo.com/zhanghuanliang/gfbegbfibnmg4v3tb6c5ri8b/%E6%8D%95%E8%8E%B7.PNG
  [6]: http://static.zybuluo.com/zhanghuanliang/1e0qf62rev3mv7usw1noau06/%E6%8D%95%E8%8E%B7.PNG
  [7]: http://static.zybuluo.com/zhanghuanliang/91a2dbeu8kywp9cgjdwoz20s/%E6%8D%95%E8%8E%B7.PNG
  [8]: http://static.zybuluo.com/zhanghuanliang/e2vpcbopkciwiv8ev7j2n9ii/%E6%8D%95%E8%8E%B7.PNG
  [9]: http://static.zybuluo.com/zhanghuanliang/9te95gccevgx91m7ftt8pwhb/%E6%8D%95%E8%8E%B7.PNG
  [10]: http://static.zybuluo.com/zhanghuanliang/05rkei512o2nidxtjczhvk8q/%E6%8D%95%E8%8E%B7.PNG
  [11]: http://static.zybuluo.com/zhanghuanliang/ituxf17svtkuybeb7bz6dk0y/%E6%8D%95%E8%8E%B7.PNG
  [12]: http://static.zybuluo.com/zhanghuanliang/l11wizq65t8dbiw6di2jib7r/%E6%8D%95%E8%8E%B7.PNG
  [13]: http://static.zybuluo.com/zhanghuanliang/8hz8gi1tv2j14ubva8sbxqxw/%E6%8D%95%E8%8E%B7.PNG
  [14]: http://static.zybuluo.com/zhanghuanliang/ll42q9vbt1ps2z6fp92g2a1g/%E6%8D%95%E8%8E%B7.PNG
  [15]: http://static.zybuluo.com/zhanghuanliang/52btovukdxxfty0we8n0i283/%E6%8D%95%E8%8E%B7.PNG
  [16]: http://static.zybuluo.com/zhanghuanliang/97uveepn1o2n26nfd5sqjm7x/%E6%8D%95%E8%8E%B7.PNG
  [17]: http://static.zybuluo.com/zhanghuanliang/cfyihiy2bpt9tfq240t9pkap/%E5%BE%AE%E4%BF%A1%E6%88%AA%E5%9B%BE_20180506120502.png
  [18]: http://static.zybuluo.com/zhanghuanliang/wp6rrpx9l2kixehliheejxew/1525579744%281%29.png
  [19]: http://static.zybuluo.com/zhanghuanliang/td238z95f256ypqvpbj9kukm/%E5%BE%AE%E4%BF%A1%E6%88%AA%E5%9B%BE_20180506121532.png
  [20]: http://static.zybuluo.com/zhanghuanliang/jz2yqy0som1xxc0susu34u2z/%E5%BE%AE%E4%BF%A1%E6%88%AA%E5%9B%BE_20180506121823.png